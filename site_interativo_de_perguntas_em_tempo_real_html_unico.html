<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConCaxo – Indústria: mitos e verdades</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    .fade-enter { opacity: 0; transform: translateY(6px); }
    .fade-enter-active { opacity: 1; transform: translateY(0); transition: all .25s ease; }

    #questionCard { touch-action: pan-y; }
  </style>
</head>
<body class="min-h-screen bg-green-50 text-gray-900 antialiased">
  <div class="max-w-5xl mx-auto p-4 md:p-8">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-green-600 text-white rounded-2xl p-4 shadow">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">ConCaxo</h1>
        <p class="text-sm md:text-base">Conferência ambiental do CAXO</p>
      </div>
      <div class="text-center md:text-right">
        <h2 class="text-lg font-semibold">Tema:</h2>
        <p class="text-sm md:text-base">Indústria: mitos e verdades sobre os impactos ambientais</p>
      </div>
      <div class="flex items-center gap-2 text-sm bg-white rounded-full px-3 py-1 text-gray-800">
        <span id="statusDot" class="inline-block w-2.5 h-2.5 rounded-full bg-red-500"></span>
        <span id="statusText">Desconectado</span>
      </div>
    </header>

    <!-- BLOCO: Login / Entrada na sala -->
    <section id="joinSection" class="mt-6 grid gap-4 md:grid-cols-2">
      <div class="bg-white rounded-2xl shadow p-4 md:p-6">
        <h2 class="text-xl font-semibold mb-3 text-green-700">Entrar em uma sala</h2>
        <p class="text-sm text-gray-600 mb-4">Use um <strong>código de sala</strong> simples (ex.: <code>geo-bio</code> ou <code>turma3A</code>). O mesmo código deve ser usado pela professora e pelos alunos.</p>
        <label class="block mb-2 text-sm font-medium">Código da sala</label>
        <input id="roomCode" class="w-full rounded-xl border p-3 mb-4" placeholder="ex.: industria-1" />

        <fieldset class="mb-4">
          <legend class="text-sm font-medium mb-2">Quem é você?</legend>
          <div class="flex gap-3 flex-wrap">
            <label class="inline-flex items-center gap-2 cursor-pointer">
              <input type="radio" name="role" value="teacher" class="accent-green-600" />
              <span>Professora</span>
            </label>
            <label class="inline-flex items-center gap-2 cursor-pointer">
              <input type="radio" name="role" value="student" class="accent-green-600" checked />
              <span>Aluno(a)</span>
            </label>
          </div>
        </fieldset>

        <div id="teacherExtras" class="hidden">
          <label class="block mb-2 text-sm font-medium">Chave de controle (opcional)</label>
          <input id="adminKey" class="w-full rounded-xl border p-3 mb-2" placeholder="defina uma palavra-passe simples" />
          <p class="text-xs text-gray-500">*Serve apenas para garantir que somente a professora avance as perguntas.</p>
        </div>

        <button id="joinBtn" class="mt-4 w-full rounded-2xl bg-green-600 text-white px-4 py-3 font-semibold hover:bg-green-700">Entrar</button>
      </div>

      <div class="bg-white rounded-2xl shadow p-4 md:p-6">
        <h2 class="text-xl font-semibold mb-3 text-green-700">Configurar Firebase</h2>
        <p class="text-sm text-gray-600 mb-3">Este site usa o <strong>Firebase Realtime Database</strong> para sincronizar a pergunta atual entre todos os dispositivos em tempo real.</p>
        <textarea id="firebaseConfigInput" class="w-full mt-3 rounded-xl border p-3 font-mono text-xs h-40" placeholder='{
  "apiKey": "...",
  "authDomain": "...",
  "databaseURL": "https://SEU-PROJETO.firebaseio.com",
  "projectId": "...",
  "storageBucket": "...",
  "messagingSenderId": "...",
  "appId": "..."
}'></textarea>
        <div class="flex gap-2 mt-3">
          <button id="saveConfigBtn" class="rounded-xl bg-green-600 text-white px-4 py-2 text-sm font-semibold">Salvar config</button>
          <button id="testConnBtn" class="rounded-xl border border-green-600 text-green-700 px-4 py-2 text-sm">Testar conexão</button>
        </div>
      </div>
    </section>

    <!-- BLOCO: Painel da Professora -->
    <section id="teacherSection" class="hidden mt-8 grid md:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow p-4 md:p-6">
        <h2 class="text-lg font-semibold mb-3 text-green-700">Perguntas (uma por linha)</h2>
        <textarea id="questionsInput" class="w-full h-56 rounded-xl border p-3 font-mono text-sm" placeholder="Digite/cole suas perguntas aqui, uma por linha..."></textarea>
        <div class="flex flex-wrap items-center gap-2 mt-3">
          <button id="pushQuestionsBtn" class="rounded-xl bg-green-600 text-white px-4 py-2 text-sm font-semibold">Enviar perguntas</button>
          <button id="prevBtn" class="rounded-xl border border-green-600 text-green-700 px-4 py-2 text-sm">◀︎ Anterior</button>
          <button id="nextBtn" class="rounded-xl border border-green-600 text-green-700 px-4 py-2 text-sm">Próxima ▶︎</button>
          <button id="resetBtn" class="rounded-xl border border-red-600 text-red-600 px-4 py-2 text-sm">Reiniciar</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Apenas a professora pode avançar ou retroceder as perguntas.</p>
      </div>

      <div class="bg-white rounded-2xl shadow p-4 md:p-6 flex flex-col">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold text-green-700">Pergunta atual</h2>
          <span id="indexBadge" class="text-xs bg-green-100 border border-green-600 text-green-700 rounded-full px-2 py-1">– / –</span>
        </div>
        <div id="questionCard" class="flex-1 grid place-items-center rounded-2xl border p-6 select-none bg-green-50">
          <p id="currentQuestion" class="text-center text-xl md:text-2xl font-semibold leading-relaxed">Aguardando perguntas…</p>
        </div>
      </div>
    </section>

    <!-- BLOCO: Visualização do Aluno -->
    <section id="studentSection" class="hidden mt-10">
      <div class="bg-white rounded-2xl shadow p-6 md:p-10">
        <div class="flex items-center justify-between gap-3 mb-4">
          <h2 class="text-lg font-semibold text-green-700">Pergunta ao vivo</h2>
          <span id="indexBadgeStudent" class="text-xs bg-green-100 border border-green-600 text-green-700 rounded-full px-2 py-1">– / –</span>
        </div>
        <div id="studentCard" class="rounded-2xl border border-green-600 p-6 grid place-items-center bg-green-50">
          <p id="studentQuestion" class="text-center text-2xl md:text-3xl font-bold leading-relaxed">Aguardando a professora iniciar…</p>
        </div>
        <p class="text-xs text-gray-500 mt-4">A pergunta muda automaticamente quando a professora avançar.</p>
      </div>
    </section>

    <footer class="mt-10 text-center text-xs text-gray-500">
      ConCaxo – Conferência ambiental do CAXO | Projeto escolar.
    </footer>
  </div>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    const state = {
      app: null,
      db: null,
      role: 'student',
      room: null,
      adminKey: '',
      currentIndex: 0,
      questions: [],
      dbRef: null,
      touch: { startX: 0, endX: 0 }
    };

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function saveLocal(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    function loadLocal(key, fallback = null) {
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
    }

    function setStatus(connected) {
      $('#statusDot').className = `inline-block w-2.5 h-2.5 rounded-full ${connected ? 'bg-green-600' : 'bg-red-500'}`;
      $('#statusText').textContent = connected ? 'Conectado' : 'Desconectado';
    }

    function fadeSwap(el, text) {
      el.classList.add('fade-enter');
      requestAnimationFrame(() => {
        el.textContent = text;
        el.classList.add('fade-enter-active');
        setTimeout(() => el.classList.remove('fade-enter', 'fade-enter-active'), 250);
      });
    }

    function initFirebaseFromLocal() {
      const cfg = loadLocal('firebaseConfig');
      if (!cfg) return false;
      try {
        state.app = firebase.initializeApp(cfg);
        state.db = firebase.database();
        setStatus(true);
        return true;
      } catch (e) {
        console.warn('Falha ao inicializar Firebase:', e);
        setStatus(false);
        return false;
      }
    }
    initFirebaseFromLocal();

    $$('input[name="role"]').forEach(r => r.addEventListener('change', (e) => {
      state.role = e.target.value;
      $('#teacherExtras').classList.toggle('hidden', state.role !== 'teacher');
    }));

    $('#roomCode').value = loadLocal('roomCode', '') || '';
    const savedRole = loadLocal('role', 'student');
    $$('input[name="role"]').forEach(r => r.checked = (r.value === savedRole));
    state.role = savedRole;
    $('#teacherExtras').classList.toggle('hidden', state.role !== 'teacher');

    $('#saveConfigBtn').addEventListener('click', () => {
      try {
        const raw = $('#firebaseConfigInput').value.trim();
        if (!raw) return alert('Cole o objeto de configuração do Firebase.');
        const cfg = JSON.parse(raw);
        saveLocal('firebaseConfig', cfg);
        alert('Configuração salva!');
      } catch (e) { alert('JSON inválido.'); }
    });

    $('#testConnBtn').addEventListener('click', () => {
      if (state.db) { alert('Conexão já ativa.'); return; }
      const ok = initFirebaseFromLocal();
      alert(ok ? 'Conectado ao Firebase!' : 'Falha na conexão.');
    });

    $('#joinBtn').addEventListener('click', async () => {
      if (!state.db) return alert('Configure o Firebase antes.');
      const room = $('#roomCode').value.trim();
      if (!room) return alert('Informe um código de sala.');

      state.room = room;
      state.adminKey = ($('#adminKey').value || '').trim();
      saveLocal('roomCode', room);
      saveLocal('role', state.role);

      $('#joinSection').classList.add('hidden');
      if (state.role === 'teacher') {
        $('#teacherSection').classList.remove('hidden');
        attachTeacher(room);
      } else {
        $('#studentSection').classList.remove('hidden');
        attachStudent(room);
      }
    });

    function roomPath(room) { return `rooms/${encodeURIComponent(room)}`; }

    function attachTeacher(room) {
      state.dbRef = state.db.ref(roomPath(room));
      state.dbRef.on('value', (snap) => {
        const data = snap.val() || {};
        state.questions = Array.isArray(data.questions) ? data.questions : [];
        state.currentIndex = Number.isInteger(data.currentIndex) ? data.currentIndex : 0;
        updateTeacherUI();
      });

      $('#pushQuestionsBtn').addEventListener('click', pushQuestions);
      $('#prevBtn').addEventListener('click', () => changeIndex(-1));
      $('#nextBtn').addEventListener('click', () => changeIndex(1));
      $('#resetBtn').addEventListener('click', () => setIndex(0));

      const card = document.getElementById('questionCard');
      card.addEventListener('touchstart', (e) => { state.touch.startX = e.changedTouches[0].clientX; });
      card.addEventListener('touchend', (e) => {
        if (state.role !== 'teacher') return;
        state.touch.endX = e.changedTouches[0].clientX;
        const dx = state.touch.endX - state.touch.startX;
        if (Math.abs(dx) > 40) {
          if (dx < 0) changeIndex(1);
          else changeIndex(-1);
        }
      });
    }

    function updateTeacherUI() {
      const total = state.questions.length;
      $('#indexBadge').textContent = total ? `${state.currentIndex + 1} / ${total}` : '– / –';
      const q = total ? (state.questions[state.currentIndex] || '—') : 'Aguardando perguntas…';
      fadeSwap($('#currentQuestion'), q);
      if (!$('#questionsInput').value.trim() && total) {
        $('#questionsInput').value = state.questions.join('\n');
      }
    }

    async function pushQuestions() {
      const lines = $('#questionsInput').value.split(/\n+/).map(s => s.trim()).filter(Boolean);
      if (lines.length === 0) return alert('Digite ao menos uma pergunta.');

      const payload = {
        questions: lines,
        currentIndex: 0,
        adminKey: state.adminKey || null,
        updatedAt: Date.now()
      };
      try { await state.db.ref(roomPath(state.room)).set(payload); } catch (e) { alert('Falha ao enviar perguntas.'); }
    }

    async function setIndex(i) {
      const total = state.questions.length;
      if (!total) return;
      const clamped = Math.max(0, Math.min(i, total - 1));
      await state.db.ref(roomPath(state.room) + '/currentIndex').set(clamped);
    }

    async function changeIndex(delta) { await setIndex(state.currentIndex + delta); }

    function attachStudent(room) {
      state.dbRef = state.db.ref(roomPath(room));
      state.dbRef.on('value', (snap) => {
        const data = snap.val() || {};
        const questions = Array.isArray(data.questions) ? data.questions : [];
        const idx = Number.isInteger(data.currentIndex) ? data.currentIndex : 0;
        const total = questions.length;
        $('#indexBadgeStudent').textContent = total ? `${idx + 1} / ${total}` : '– / –';
        const q = total ? (questions[idx] || '—') : 'Aguardando a professora iniciar…';
        fadeSwap($('#studentQuestion'), q);
      });
    }
  </script>
</body>
</html>
